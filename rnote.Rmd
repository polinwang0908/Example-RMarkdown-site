---
title: "R Note"
output:
  html_document:
    toc: true
    toc_float: true

---
**************
### Fixed Effect \& Clustering

Two ways of getting fixed effect estimation and clustering standard errors: `plm` and `felm`. They are consistent without fixed effect, and are slightly different in degree of freedom adjustment when running with either one or both dimensions of fixed effect.

> When both a firm and a time effect are present in the data, researchers can address one parametrically (e.g., by including time dummies) and then estimate standard errors clustered on the other dimension. Alternatively, researchers can cluster on multiple dimensions. When there are a sufficient number of clusters in each dimension, standard errors clustered on multiple dimensions are unbiased and produce correctly sized confidence intervals whether the firm effect is permanent or temporary. ~ Petersen (2008)

```{r, message=FALSE, warning=FALSE,echo=TRUE,include=TRUE}
# Loading the required libraries
library(plm)
library(lmtest)
library(multiwayvcov)
library(lfe)
library(stargazer)
# Loading Petersen's dataset
data(petersen)

# Pooled OLS model
pooled.ols<-plm(y~x,data=petersen,model="pooling",index=c("firmid", "year"))

# Fixed effects model
fe.firm<-plm(y~x,data=petersen,model="within",index=c("firmid", "year"))
```

```{r, results="asis"}

# Clustered standard errors - OLS (by firm)
stargazer(coeftest(pooled.ols,vcov=vcovHC(pooled.ols,type="sss",cluster="group")),
          felm(y~x|0|0|firmid,data=petersen),type='html')

# Clustered standard errors - OLS (by time)
stargazer(coeftest(pooled.ols,vcov=vcovHC(pooled.ols,type="sss",cluster="time")),
          felm(y~x|0|0|year,data=petersen),type='html')

# Clustered standard errors - OLS (by firm and time)
stargazer(coeftest(pooled.ols,vcov=vcovDC(pooled.ols,type="sss")),
          felm(y~x|0|0|firmid+year,data=petersen),type='html')

# Clustered standard errors - Fixed effect regression (by firm)
stargazer(coeftest(fe.firm,vcov=vcovHC(fe.firm,type="sss",cluster="group")),
          felm(y~x|firmid|0|firmid,data=petersen),type='html')

# Clustered standard errors - Fixed effect regression (by time)
stargazer(coeftest(fe.firm,vcov=vcovHC(fe.firm,type="sss",cluster="time")),
          felm(y~x|firmid|0|year,data=petersen),type='html')

# Clustered standard errors - Fixed effect regression (by firm and time)
stargazer(coeftest(fe.firm,vcov=vcovDC(fe.firm,type="sss")),
          felm(y~x|firmid|0|firmid+year,data=petersen),type='html')

```

**************

### Debugging

- Function to trace back to upper level: `recover()`.

**************

### R Markdown Note

- Link: `[link](http://xxxx.com)`
- Quote: `>abc`
- Numbered header `#.`
- Stargazer header removal: `header=FALSE`
- Upload website to github:
    1. Build Website
    1. Command in shell
        - `git add -A`
        - `git commit -m "My first website"`
        - `git push origin master`
- Matrices
    1. Jacobian
        - Change of variable `x`, `y` $\to$ `u`, `v`
        - Determinant of $$\left[\begin{array}{rr}\frac{dx}{du} & \frac{dx}{dv}\\ \frac{dy}{du} & \frac{dy}{dv}\end{array}\right]
$$
    1. Hessian: all combinations of 2nd derivative
    
**************

### Relevel Factor

- Change reference group to: `relevel(RATING,4)`

**************

### A List of Regressions

Applying the regression function on a list of data gives a flexibility and convenience to run hundreds of regression models just with 3~4 lines of code.

The following performs year fixed effect regression with firm clustering on a set of varing dependent variables (2) and independent variables (11). `lapply` applies the regression funciton to each rating change, and for loop changes the dependent variable through `NONGRP_AVE` and `TOTAL_AVE`. Differences in the dependent variables are recorded in the first dimesion of the list `[[i]]` whereas the differences of independent variables are recorded in the second dimension `[[i]][[1:11]]`. Results are presented by `stargazer` package.

```{r, message=FALSE, warning=FALSE,echo=FALSE,include=FALSE}
rm(list=ls())
library(reshape)
library(reshape2)
library(ggplot2)
library(plyr)
library(dplyr)
library(haven)
library(plm)
library(lfe)
library(data.table)
library(lmtest)
library(multiwayvcov)
library(stargazer)
library(psych)
#============================================================================
Root   <-"~/Google Drive/UGA/NAICData_R/"
OutPath<-paste(Root,"Life/StatementsData/",sep="")
#--------------------------------------------------------------------------
load(paste(Root,"Projects/Project1/DataLife2.Rta",sep=""))
MainData<-MainData[MainData$MUTUAL==1|MainData$STOCK==1,]
# 18680 -> lag,winsor,na
load(paste(Root,"Projects/Project1/Rating_AMBest_Full.Rta",sep=""));df_dups <- Data[c("COCODE", "YEAR")];Data<-Data[!duplicated(df_dups),]
MainData<-left_join(MainData,Data,by=c("YEAR","COCODE"))
MainData<-na.omit(MainData)
# 12205 -> lag,winsor,na
load(paste(OutPath,"REINS.Rta",sep=""))
MainData<-left_join(MainData,Data)
MainData<-na.omit(MainData)

load(paste(OutPath,"PolSize.Rta",sep=""))
Data<-subset(Data,select=c("COCODE","YEAR","TOTAL_AVE","GRP_AVE","NONGRP_AVE"))
MainData<-left_join(MainData,Data)
MainData<-na.omit(MainData)
MainData$PRICE<-winsor(MainData$PRICE,.01)
MainData$REINS<-winsor(MainData$REINS,.01)
MainData<-pdata.frame(MainData)
MainData$lagREINS<-lag(MainData$REINS)
#--------------------------------------------------------------------------
```
```{r, message=FALSE, warning=FALSE,echo=TRUE,include=TRUE}
my_dep<-c("NONGRP_AVE","TOTAL_AVE")
my_lm <-list(1:2)
#--------------------------------------------------------------------------
for(i in 1:2){
my_lm[[i]]<-lapply(1:10, function(x) felm(get(my_dep[i]) ~ I(RATING>x)
           +SINGLE+HERF+NATIONAL+NYREG+STOCK+SIZE+AGE+lag(REINS)|YEAR|0|COCODE,data=MainData))
test<-felm(get(my_dep[i]) ~ RATING
           +SINGLE+HERF+NATIONAL+NYREG+STOCK+SIZE+AGE+lag(REINS)|YEAR|0|COCODE,data=MainData)
my_lm[[i]][[11]]<-test
}
```
```{r, results="asis"}
stargazer::stargazer(my_lm[1],type='html',dep.var.labels=my_dep[1])
stargazer::stargazer(my_lm[2],type='html',dep.var.labels=my_dep[2])
```

***********

### Multiple Boxplot

```{r, message=FALSE, warning=FALSE, stageOne,echo=FALSE,include=FALSE}
load(paste(Root,"Projects/Project1/MainData_RATING_REIN_WR_test.Rta",sep=""))
MainData$PRE<-as.numeric(I(MainData$YEAR>=1997))
```
```{r, message=FALSE, warning=FALSE, echo=TRUE}
library(tableone)
CreateTableOne(data=MainData[MainData$PRE==0,],vars='PRICE',strata = 'NYREG')
CreateTableOne(data=MainData[MainData$PRE==1,],vars='PRICE',strata = 'NYREG')
ggplot(MainData, aes(x=as.factor(NYREG),y=PRICE,fill=as.factor(NYREG))) + geom_boxplot()+facet_wrap(~PRE)
```

***********

### Directly Load HMD Data

```{r, message=FALSE, warning=FALSE,echo=FALSE,include=FALSE}
user_hmd<-"polinwang@uga.edu"
pass_hmd<-"Zubaby0822"
```
```{r, message=FALSE, warning=FALSE, echo=TRUE}
# load required packages
library(HMDHFDplus)

# load life tables for men, USA and JPN
usa <- readHMDweb('USA', "mltper_1x1", user_hmd, pass_hmd)
jpn <- readHMDweb('JPN', "mltper_1x1", user_hmd, pass_hmd)
plot(usa[usa$Year==1933,]$Lx~usa[usa$Year==1933,]$Age,type='l')
```